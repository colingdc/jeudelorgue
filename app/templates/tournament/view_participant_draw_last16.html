{% extends "base.html" %}

{% block styles %}
{{ super() }}

<link rel="stylesheet" href="{{ url_for('static', filename='css/draw.css') }}">

{% endblock %}


{% block content %}

<a class="btn btn-default"
   href="{{ url_for('.view_tournament', tournament_id=tournament.id) }}">
    <span class="fa fa-arrow-left"></span>
    Revenir au tournoi
</a>

<div class="panel panel-default">

    <div class="panel-heading">
        <h3 class="panel-title">Tableau de {{ participant.user.username }} (à partir des huitièmes) - Classement : {{ participant.ranking }} / {{ tournament.participants.count() }} (Score : {{ participant.score }}/{{ tournament.get_current_maximal_score() }})</h3>
    </div>

    <div class="panel-body" style ="overflow-x:scroll">
        <main id="round-names">
            {% for round in tournament.get_matches_by_round_last16() %}
                <div class="round">
                    <div class="round-name">
                        {{ tournament.get_round_names_last16()[loop.index - 1] }}
                    </div>
                </div>
            {% endfor %}
                <div class="round">
                    <div class="round-name">
                        V
                    </div>
                </div>
        </main>

        <main id="tournament">


            {% for round in tournament.get_matches_by_round_last16() %}

                {% set outer_loop = loop %}
                {% if loop.index < loop.length %}

                    <div class="round">
                        <div class="spacer">
                            &nbsp;
                        </div>

                        {% for match in round["matches"] %}

                            {% with next_match = match.get_next_match() %}

                                {% with forecast = match.get_forecast(participant.id) %}
                                    {% if forecast.winner %}

                                        <div id="player-{{ next_match.position }}-{{ loop.cycle(0, 1) }}"
                                            class="game game-player match
                                            {% if outer_loop.index == 1 %}
                                                first-round
                                            {% endif %}
                                            {% if match.winner_id %}
                                                {% if match.winner_id == forecast.winner_id %}
                                                    correct_forecast
                                                {% else %}
                                                    incorrect_forecast
                                                {% endif %}
                                            {% elif forecast.winner.is_eliminated() %}
                                                incorrect_forecast
                                            {% endif %}"
                                            tournament_player_id="{{ forecast.winner_id }}"
                                            match_position_id="{{ next_match.position }}"
                                            match_id="{{ next_match.id }}"
                                            title="{% if match.winner and (match.winner_id != forecast.winner.id) %}
                                                    Vainqueur réel : {{ match.winner.get_full_name() | truncate(25) }}
                                                {% endif %}">
                                                {{ forecast.winner.get_full_name() | truncate(25) }}
                                        </div>

                                    {% else %}

                                        <div id="player-{{ next_match.position }}-{{ loop.cycle(0, 1) }}"
                                            class="game game-player match
                                            {% if outer_loop.index == 1 %}
                                                first-round
                                            {% endif %}"
                                            tournament_player_id="None"
                                            match_position_id="{{ next_match.position }}"
                                            match_id="{{ next_match.id }}">
                                            &nbsp;
                                        </div>

                                    {% endif %}

                                    <div class="{{ loop.cycle('game game-spacer', 'spacer') }}">
                                        &nbsp;
                                    </div>

                                {% endwith %}
                            {% endwith %}
                        {% endfor %}

                    </div>
                {% else %}

                    {% with match = round["matches"][0] %}
                        {% with forecast = match.get_forecast(participant.id) %}
                            <div class="round last-round">
                                <div id="player-0-1"
                                    class="game game-player
                                    {% if match.winner_id %}
                                        {% if match.winner_id == forecast.winner_id %}
                                            correct_forecast
                                        {% else %}
                                            incorrect_forecast
                                        {% endif %}
                                    {% elif forecast.winner.is_eliminated() %}
                                        incorrect_forecast
                                    {% endif %}"
                                    tournament_player_id="{{ match.winner_id }}"
                                    title="{% if match.winner and (match.winner_id != forecast.winner.id) %}
                                            Vainqueur réel : {{ match.winner.get_full_name() | truncate(25) }}
                                            {% endif %}">
                                    {% if forecast.winner %}
                                        {{ forecast.winner.get_full_name() | truncate(25) }}
                                    {% else %}
                                        &nbsp;
                                    {% endif %}
                                </div>
                            </div>
                        {% endwith %}
                    {% endwith %}
                {% endif %}
            {% endfor %}

        </main>

        </div>
    </div>


{% endblock %}

